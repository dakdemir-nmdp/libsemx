---
title: "MDP Genomic Analysis with semx"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Assuming semx is installed. If running from source dev environment, 
# one might need devtools::load_all("Rpkg/semx")
tryCatch(library(semx), error = function(e) {
  message("semx package not found. Attempting to load from source...")
  if (file.exists("../../Rpkg/semx")) {
    devtools::load_all("../../Rpkg/semx")
  } else {
    stop("Could not load semx package.")
  }
})
library(dplyr)
library(readr)
```

## 1. Load and Preprocess Data

We load the numeric SNP data and phenotype data.

```{r load_data}
# Adjust paths as needed
numeric_df <- read_csv("../../data/mdp_numeric.csv", show_col_types = FALSE)
traits_df <- read_csv("../../data/mdp_traits.csv", show_col_types = FALSE)

cat("Numeric DF dim:", dim(numeric_df), "\n")
cat("Traits DF dim:", dim(traits_df), "\n")

# Rename Taxa to taxa in traits_df for consistency
traits_df <- traits_df %>% rename(taxa = Taxa)

# Ensure taxa is character
numeric_df$taxa <- as.character(numeric_df$taxa)
traits_df$taxa <- as.character(traits_df$taxa)

# Merge datasets
merged_df <- inner_join(numeric_df, traits_df, by = "taxa")

# Drop rows with missing EarHT
merged_df <- merged_df %>% filter(!is.na(EarHT))

cat("Merged DF dim:", dim(merged_df), "\n")

# Sort by taxa
merged_df <- merged_df %>% arrange(taxa)

# Extract Markers
# Identify marker columns (all except taxa and traits)
trait_cols <- c("taxa", "EarHT", "dpoll", "EarDia")
marker_cols <- setdiff(names(numeric_df), "taxa")

M <- as.matrix(merged_df[, marker_cols])
cat("Marker Matrix dim:", dim(M), "\n")

# Standardize Phenotype
merged_df$EarHT_std <- scale(merged_df$EarHT)

# Convert taxa to numeric factor for semx
# semx currently requires all data columns passed to fit() to be numeric.
# We convert the grouping variable 'taxa' to integer codes.
merged_df$taxa <- as.numeric(as.factor(merged_df$taxa))

# Add a dummy grouping variable for GBLUP (single group)
merged_df$all_groups <- 1
```

## 2. Define Genomic Model

We define the mixed model:
$ y = \mu + u + e $

```{r define_model}
# Define the model
# Note: In R, we pass the marker matrix in the genomic list.
model <- semx_model(
  equations = c("EarHT_std ~ 1"),
  families = c(EarHT_std = "gaussian"),
  genomic = list(
    polygenic = list(
      markers = M,
      structure = "grm"
    )
  ),
  random_effects = list(
    list(
      name = "u",
      variables = c("all_groups"),
      covariance = "polygenic"
    )
  )
)
```

## 3. Fit Model and Analyze Results

```{r fit_model}
# Fit the model
fit <- semx_fit(model, merged_df)

# Display Summary
summary(fit)

# Extract Variance Components
# Note: semx returns variance components in the parameters list.
# For a GRM model, we expect 'cov_re_1_polygenic' (genetic variance) and 'psi_EarHT_std_EarHT_std' (residual variance).
# The names might vary based on internal naming.
params <- fit$optimization_result$parameters
if (!is.null(fit$parameter_names)) {
  names(params) <- fit$parameter_names
}
print(params)
```
